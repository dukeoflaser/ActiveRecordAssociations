<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>ActiveRecord Associations by dukeoflaser</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>ActiveRecord Associations</h1>
          <h2>A study of ActiveRecord&#39;s associations and their generated methods.</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/dukeoflaser/ActiveRecordAssociations/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/dukeoflaser/ActiveRecordAssociations/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/dukeoflaser/ActiveRecordAssociations" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h2>
<a id="activerecord-associations" class="anchor" href="#activerecord-associations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ActiveRecord Associations</h2>

<p>A study of ActiveRecord's Associations and their generated methods.</p>

<h5>
<a id="questions-what-methods-are-generated-for-each-association-type-what-is-the-required-database-column-in-the-matching-table-how-do-the-args-passed-to-the-initialize-method-affect-the-situation" class="anchor" href="#questions-what-methods-are-generated-for-each-association-type-what-is-the-required-database-column-in-the-matching-table-how-do-the-args-passed-to-the-initialize-method-affect-the-situation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Questions: What methods are generated for each association type? What is the required database column in the matching table? How do the args passed to the <code>initialize</code> method affect the situation?</h5>

<p>We'll experiment with four models: Game, World, Character, and PowerUp.</p>

<p>A World <code>has_many</code> characters and powerups. We're looking for the following behaviour:</p>

<ul>
<li><code>mushroom_kingdom.characters =&gt;[...]</code></li>
<li><code>mushroom_kingdom.power_ups =&gt; [...]</code></li>
</ul>

<p>Characters and Powerups both <code>belong_to</code> a World.</p>

<ul>
<li><code>mario.world =&gt; #&lt;World ...&gt;</code></li>
<li><code>fire_flower.world =&gt; #&lt;World ...&gt;</code></li>
</ul>

<p>A Character <code>has_many</code> powerups available <code>through</code> the world. </p>

<ul>
<li><code>mario.power_ups =&gt; [...]</code></li>
</ul>

<p>A Powerup <code>belongs_to</code> <em>many</em> characters. </p>

<ul>
<li><code>fire_flower.characters =&gt; [...]</code></li>
</ul>

<p>Additionally, a Game has many characters but a character also has many games.</p>

<ul>
<li><code>mario.games =&gt; [...]</code></li>
<li><code>game.characters =&gt; [...]</code></li>
</ul>

<h2>
<a id="control" class="anchor" href="#control" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Control</h2>

<p>First we need a control model to compare our results against. This will be a blank class that inherits from ActiveRecord. The only column it will have will be its automatically generated <code>id</code> column.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Blank<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
<span class="pl-k">end</span>

<span class="pl-k">class</span> <span class="pl-en">CreateBlanksTable<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    create_table <span class="pl-c1">:blanks</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<div class="highlight highlight-source-ruby"><pre>control <span class="pl-k">=</span> <span class="pl-c1">Blank</span>.<span class="pl-k">new</span>
=&gt; <span class="pl-c">#&lt;Blank id: nil&gt;</span>
control_methods <span class="pl-k">=</span> control.methods.map {|<span class="pl-smi">m</span>| m.to_s}.sort!
control_class_methods <span class="pl-k">=</span> <span class="pl-c1">Blank</span>.methods.map {|<span class="pl-smi">m</span>| m.to_s}.sort!</pre></div>

<p>The list of control methods can be found <a href="https://github.com/MooseBoost/ActiveRecordAssociations/blob/master/control_instance_methods.md" title="Instance Methods">here</a> and <a href="https://github.com/MooseBoost/ActiveRecordAssociations/blob/master/control_class_methods.md" title="Class Methods">here</a>.</p>

<h2>
<a id="world" class="anchor" href="#world" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>World</h2>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">World<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_many <span class="pl-c1">:characters</span>
<span class="pl-k">end</span></pre></div>

<p>Create a corresponding table with a column for the name of the world.
Note that the <em>plural</em> version of the class is used for the table.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">CreateWorldTable<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    create_table <span class="pl-c1">:worlds</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
      t.string <span class="pl-c1">:name</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Migrate the change over to the database.</p>

<div class="highlight highlight-source-ruby"><pre>rake <span class="pl-c1">db:</span>migrate</pre></div>

<p><code>db/schema.rb</code> now has the following:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">ActiveRecord</span>::<span class="pl-c1">Schema</span>.define(<span class="pl-c1">version:</span> <span class="pl-c1">20160405222201</span>) <span class="pl-k">do</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>worlds<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

<span class="pl-k">end</span></pre></div>

<p>Let's now create a world that has no name. It will be a simple instance, with no attributes.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span> the_world <span class="pl-k">=</span> <span class="pl-c1">World</span>.create
<span class="pl-c1">D</span>, [<span class="pl-c1">2016</span><span class="pl-k">-</span><span class="pl-c1">04</span><span class="pl-k">-</span>05<span class="pl-c1">T22:</span><span class="pl-c1">33</span>:<span class="pl-c1">05.639088</span> <span class="pl-c">#3388] DEBUG -- :    (0.2ms)  begin transaction</span>
<span class="pl-c1">D</span>, [<span class="pl-c1">2016</span><span class="pl-k">-</span><span class="pl-c1">04</span><span class="pl-k">-</span>05<span class="pl-c1">T22:</span><span class="pl-c1">33</span>:<span class="pl-c1">05.644635</span> <span class="pl-c">#3388] DEBUG -- :   SQL (0.5ms)  INSERT INTO "worlds" DEFAULT VALUES</span>
<span class="pl-c1">D</span>, [<span class="pl-c1">2016</span><span class="pl-k">-</span><span class="pl-c1">04</span><span class="pl-k">-</span>05<span class="pl-c1">T22:</span><span class="pl-c1">33</span>:<span class="pl-c1">05.657346</span> <span class="pl-c">#3388] DEBUG -- :    (12.0ms)  commit transaction</span>
=&gt; <span class="pl-c">#&lt;World id: 1, name: nil&gt;</span></pre></div>

<p>We are now ready to make our comparisons.</p>

<h3>
<a id="a-world-that-has_many-characters" class="anchor" href="#a-world-that-has_many-characters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A <em>World</em> that <code>has_many</code> <em>characters</em>
</h3>

<p>Note: The list of methods was created like this:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span> world_methods <span class="pl-k">=</span> the_world.methods.map {|<span class="pl-smi">m</span>| m.to_s}.sort!
<span class="pl-k">&gt;&gt;</span> (world_methods <span class="pl-k">-</span> control_methods).each {|<span class="pl-smi">m</span>| puts m}

<span class="pl-k">&gt;&gt;</span> world_class_methods <span class="pl-k">=</span> <span class="pl-c1">World</span>.methods.map {|<span class="pl-smi">m</span>| m.to_s}.sort!
<span class="pl-k">&gt;&gt;</span> (world_class_methods <span class="pl-k">-</span> control_class_methods).each {|<span class="pl-smi">m</span>| puts m}</pre></div>

<p>Again, here is our model and its table.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">World<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_many <span class="pl-c1">:characters</span>
<span class="pl-k">end</span></pre></div>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">CreateWorldTable<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    create_table <span class="pl-c1">:worlds</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
      t.string <span class="pl-c1">:name</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h5>
<a id="generated-has_many-methods" class="anchor" href="#generated-has_many-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Generated <code>has_many</code> Methods</h5>

<table>
<thead>
<tr>
<th>From <code>has_many(:characters)</code>
</th>
<th>From DB column :name</th>
<th>Class Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td>after_add_for_characters</td>
<td>name</td>
<td>after_add_for_characters</td>
</tr>
<tr>
<td>after_add_for_characters=</td>
<td>name=</td>
<td>after_add_for_characters=</td>
</tr>
<tr>
<td>after_add_for_characters?</td>
<td>name?</td>
<td>after_add_for_characters?</td>
</tr>
<tr>
<td>after_remove_for_characters</td>
<td>name_before_type_cast</td>
<td>after_remove_for_characters</td>
</tr>
<tr>
<td>after_remove_for_characters=</td>
<td>name_came_from_user?</td>
<td>after_remove_for_characters=</td>
</tr>
<tr>
<td>after_remove_for_characters?</td>
<td>name_change</td>
<td>after_remove_for_characters?</td>
</tr>
<tr>
<td>autosave_associated_records_for_characters</td>
<td>name_changed?</td>
<td></td>
</tr>
<tr>
<td>before_add_for_characters</td>
<td>name_was</td>
<td>before_add_for_characters</td>
</tr>
<tr>
<td>before_add_for_characters=</td>
<td>name_will_change!</td>
<td>before_add_for_characters=</td>
</tr>
<tr>
<td>before_add_for_characters?</td>
<td>reset_name!</td>
<td>before_add_for_characters?</td>
</tr>
<tr>
<td>before_remove_for_characters</td>
<td>restore_name!</td>
<td>before_remove_for_characters</td>
</tr>
<tr>
<td>before_remove_for_characters=</td>
<td></td>
<td>before_remove_for_characters=</td>
</tr>
<tr>
<td>before_remove_for_characters?</td>
<td></td>
<td>before_remove_for_characters?</td>
</tr>
<tr>
<td>character_ids</td>
<td></td>
<td></td>
</tr>
<tr>
<td>character_ids=</td>
<td></td>
<td></td>
</tr>
<tr>
<td>characters</td>
<td></td>
<td></td>
</tr>
<tr>
<td>characters=</td>
<td></td>
<td></td>
</tr>
<tr>
<td>validate_associated_records_for_characters</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<p>As you can see, ActiveRecord generates instance methods based on both names of the columns in the database and the various association macros. There are other methods that can be called on the results of these methods such as <code>characters.clear</code>. A list can be found <a href="http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html" title="Generated Methods">here</a></p>

<h3>
<a id="a-character-belongs_to-a-world" class="anchor" href="#a-character-belongs_to-a-world" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A <em>Character</em> <code>belongs_to</code> a <em>world</em>
</h3>

<p>If a model is a child of another model it gets a <code>belongs_to</code> association. If a model has two or more parents it can belong to all of them through multiple <code>belongs_to</code> method calls. Another way of looking at the <code>belongs_to</code> association is to ask youself if you want this kind of method: <code>child.dad =&gt; #&lt;Dad...&gt;</code> or <code>child.mom =&gt; #&lt;Mom...&gt;</code></p>

<p>If a model is a child of anything, it requires a parent_id column to be added to it's corresponding table. Any column with a <code>_id</code> suffix becomes a foreign key that points to the corresponding table's id column. So, if a character is a child of world, it will need a world_id column to point to the <code>worlds</code> table <code>id</code> column.</p>

<p>Here is our Character model.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Character<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  belongs_to <span class="pl-c1">:world</span>
<span class="pl-k">end</span></pre></div>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">CreateCharactersTable<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    create_table <span class="pl-c1">:characters</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
      t.string <span class="pl-c1">:name</span>
      t.integer <span class="pl-c1">:world_id</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Here is a nameless character.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span> the_character <span class="pl-k">=</span> <span class="pl-c1">Character</span>.<span class="pl-k">new</span>
=&gt; <span class="pl-c">#&lt;Character id: nil, name: nil, world_id: nil&gt;</span>
<span class="pl-k">&gt;&gt;</span> character_methods <span class="pl-k">=</span> the_character.methods.map {|<span class="pl-smi">method</span>| method.to_s}.sort!
<span class="pl-k">&gt;&gt;</span> (character_methods <span class="pl-k">-</span> control_methods).each {|<span class="pl-smi">m</span>| puts m}</pre></div>

<h5>
<a id="generated-belongs_to-methods" class="anchor" href="#generated-belongs_to-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Generated <code>belongs_to</code> methods</h5>

<table>
<thead>
<tr>
<th>From <code>belongs_to(:world)</code>
</th>
<th>From DB column :name</th>
<th>Class Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td>world</td>
<td>name</td>
<td><strong>none</strong></td>
</tr>
<tr>
<td>world=</td>
<td>name=</td>
<td></td>
</tr>
<tr>
<td>autosave_associated_records_for_world</td>
<td>name?</td>
<td></td>
</tr>
<tr>
<td>belongs_to_counter_cache_after_update</td>
<td>name_before_type_cast</td>
<td></td>
</tr>
<tr>
<td>build_world</td>
<td>name_came_from_user?</td>
<td></td>
</tr>
<tr>
<td>create_world</td>
<td>name_change</td>
<td></td>
</tr>
<tr>
<td>create_world!</td>
<td>name_changed?</td>
<td></td>
</tr>
<tr>
<td></td>
<td>name_was</td>
<td></td>
</tr>
<tr>
<td></td>
<td>name_will_change!</td>
<td></td>
</tr>
<tr>
<td></td>
<td>reset_name!</td>
<td></td>
</tr>
<tr>
<td></td>
<td>restore_name!</td>
<td></td>
</tr>
</tbody>
</table>

<h3>
<a id="a-character-has_many-power_ups-through-world" class="anchor" href="#a-character-has_many-power_ups-through-world" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A <em>Character</em> <code>has_many</code> <em>power_ups</em> <code>through:</code> <em>world</em>
</h3>

<p>At this point, we've looked at the generated methods we end up with when our class has both a <code>belongs_to</code> relationship and a <code>has_many</code> relationship. A Character model with both of those relationships would have both sets of methods, along with the database-column generated methods. But what about this <code>has_many through:</code> association, that we've got going on between our Characters and their many powerups? Do we get any additional methods showing up? The answer to that question is simply this: no.</p>

<h3>
<a id="its-a-me" class="anchor" href="#its-a-me" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>It's-a Me....</h3>

<p>I've gone ahead and created the world <code>mushroom_kingdom</code> with a name of "Mushroom Kingdom". I've also created two characters named Mario and Luigi along with two powerups: <code>mushroom</code>, and <code>fire_flower</code>.</p>

<p>As stated at the beginning, these are the associations we are after:</p>

<div class="highlight highlight-source-ruby"><pre>mushroom_kingdom.characters =&gt;[...]
mushroom_kingdom.power_ups =&gt; [...]
mario.world =&gt; <span class="pl-c">#&lt;World ...&gt;</span>
fire_flower.world =&gt; <span class="pl-c">#&lt;World ...&gt;</span>
mario.power_ups =&gt; [...]
fire_flower.characters =&gt; [...]</pre></div>

<p>Here are updated versions of each of our three classes.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">World<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_many <span class="pl-c1">:characters</span>
  has_many <span class="pl-c1">:power_ups</span>
<span class="pl-k">end</span></pre></div>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Character<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  belongs_to <span class="pl-c1">:world</span>
  has_many <span class="pl-c1">:power_ups</span>, <span class="pl-c1">through:</span> <span class="pl-c1">:world</span>
<span class="pl-k">end</span></pre></div>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">PowerUp<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  belongs_to <span class="pl-c1">:world</span>
  belongs_to <span class="pl-c1">:character</span>
<span class="pl-k">end</span></pre></div>

<p>And here is our current database schema.
Note: The name of the <code>power_ups</code> table has an underscore where the class name had an uppercase letter.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">ActiveRecord</span>::<span class="pl-c1">Schema</span>.define(<span class="pl-c1">version:</span> <span class="pl-c1">20160406024221</span>) <span class="pl-k">do</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>characters<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string  <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>world_id<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>power_ups<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string  <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>world_id<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>worlds<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>charcter_id<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>power_ups_id<span class="pl-pds">"</span></span>    
  <span class="pl-k">end</span>

<span class="pl-k">end</span></pre></div>

<p>So lets test some of our methods. 
If we give Mario a world to live in, like this:</p>

<div class="highlight highlight-source-ruby"><pre>mario.world <span class="pl-k">=</span> mushroom_kingdom</pre></div>

<p>We expect our <code>mushroom_kingdom.characters</code> to return some info about its single inhabitant, Mario.
Instead, however, we get this:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span> mushroom_kingdom.characters.first
=&gt; <span class="pl-c1">nil</span></pre></div>

<p>Hmmm...</p>

<hr>

<p>The problem is this: 
<strong>Children are not responsible</strong>.</p>

<hr>

<p>Rather than telling a child object (<code>mario</code>) something the parent needs to know, we need to tell the parent (<code>mushroom_kingdom</code>). The parent is the responsible one in the relationship and will let the child object know what it needs to know.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span> goomba <span class="pl-k">=</span> <span class="pl-c1">Character</span>.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">"</span>Goomba<span class="pl-pds">"</span></span>)
=&gt; <span class="pl-c">#&lt;Character id: 3, name: "Goomba", world_id: nil&gt;</span>

<span class="pl-k">&gt;&gt;</span> mushroom_kingdom.characters <span class="pl-k">&lt;&lt;</span> goomba
<span class="pl-k">&gt;&gt;</span> goomba.world
=&gt; <span class="pl-c">#&lt;World id: 1, name: "Mushroom Kingdom"&gt;</span>

<span class="pl-k">&gt;&gt;</span> goomba
=&gt; <span class="pl-c">#&lt;Character id: 3, name: "Goomba", world_id: 1&gt;</span>

<span class="pl-k">&gt;&gt;</span> mushroom_kingdom.power_ups <span class="pl-k">&lt;&lt;</span> mushroom
<span class="pl-k">&gt;&gt;</span> mushroom_kingdom.power_ups <span class="pl-k">&lt;&lt;</span> fire_flower
<span class="pl-k">&gt;&gt;</span> fire_flower.world
=&gt; <span class="pl-c">#&lt;World id: 1, name: "Mushroom Kingdom"&gt;</span></pre></div>

<p>So our associations are starting to come together - as long as we are giving our information to the parent and not the irresponsible child. So how about the <code>has_many through:</code> association between our characters and our powerups?</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span> mario.power_ups.first.name
=&gt; <span class="pl-s"><span class="pl-pds">"</span>Mushroom<span class="pl-pds">"</span></span></pre></div>

<p>Seems to work. The key to making this <code>has_many through:</code> association work is in the database. If you look at the <code>worlds</code> table above, you'll notice that it has foreign keys (<code>_id</code> columns) for both the <code>characters</code> table and the <code>power_ups</code> table. This is what ties our characters to our powerups. As a general rule, <strong>the <code>through:</code> table gets foreign keys for current model and its child</strong>. So what about asking our fire flower which characters have access to it?</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">&gt;&gt;</span>fire_flower.characters.first.name
=&gt; <span class="pl-c1">NoMethodError:</span> undefined method <span class="pl-s"><span class="pl-pds">`</span>characters' for #&lt;PowerUp id: 2, name: "Fire Flower", world_id: 1&gt;</span></pre></div>

<p>If we look back to our generated methods, we see that it is the <code>has_many</code> macro that gives us our <code>______s</code> method. Our PowerUp class, however, is using the <code>belongs_to</code> macro which does not generate such a method.</p>

<hr>

<p><em>When we ask the powerup for a list of characters that own it, it may seems as it <code>belongs_to</code> specific characters. However, given the <code>characters</code> method that we want, we should view the powerup as though it <code>has_many</code> owners.</em></p>

<hr>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">PowerUp<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  belongs_to <span class="pl-c1">:world</span>
  has_many <span class="pl-c1">:characters</span>, <span class="pl-c1">through:</span> <span class="pl-c1">:world</span>
<span class="pl-k">end</span></pre></div>

<p>Our <code>world</code> table is already setup with the proper foreign keys.</p>

<div class="highlight highlight-source-ruby"><pre>fire_flower.characters.first.name
=&gt; <span class="pl-s"><span class="pl-pds">"</span>Mario<span class="pl-pds">"</span></span></pre></div>

<p>The relationship that characters have with powerups would be called a <em>many to many</em> relationship, as a character can have many powerups, and a powerup can have many owning characters.</p>

<h3>
<a id="many-to-many" class="anchor" href="#many-to-many" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Many to Many</h3>

<p>You can also set up this kind of association by using the <code>has_and_belongs_to_many</code> macro.
To experiment with this, we'll use a <code>Game</code> model to interact with our characters. Our desired behaviour looks like this:</p>

<div class="highlight highlight-source-ruby"><pre>mario.games =&gt; [...]
super_mario_bros.characters =&gt; [...]</pre></div>

<p>Our classes will need the new macro.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Game<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_and_belongs_to_many <span class="pl-c1">:characters</span>
<span class="pl-k">end</span>

<span class="pl-k">class</span> <span class="pl-en">Character<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  belongs_to <span class="pl-c1">:world</span>
  has_many <span class="pl-c1">:power_ups</span>, <span class="pl-c1">through:</span> <span class="pl-c1">:world</span>
  has_and_belongs_to_many <span class="pl-c1">:games</span>
<span class="pl-k">end</span></pre></div>

<p>Additionally, we need a special table in our database called a <em>join table</em>. This is a table that only has two foreign keys: one for each of our models.</p>

<p>We'll create that, and a table for our <code>Game</code> class in two seperate migrations.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">CreateGamesTable<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    create_table <span class="pl-c1">:games</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
      t.string <span class="pl-c1">:name</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">CreateCharacterGameTable<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    create_table <span class="pl-c1">:characters_games</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
      t.integer <span class="pl-c1">:character_id</span>
      t.integer <span class="pl-c1">:game_id</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>After migration, our schema now looks like this:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">ActiveRecord</span>::<span class="pl-c1">Schema</span>.define(<span class="pl-c1">version:</span> <span class="pl-c1">20160407042123</span>) <span class="pl-k">do</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>characters<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string  <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>world_id<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>characters_games<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.integer <span class="pl-s"><span class="pl-pds">"</span>character_id<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>game_id<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>games<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>power_ups<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string  <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>world_id<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  create_table <span class="pl-s"><span class="pl-pds">"</span>worlds<span class="pl-pds">"</span></span>, <span class="pl-c1">force:</span> <span class="pl-c1">:cascade</span> <span class="pl-k">do </span>|<span class="pl-smi">t</span>|
    t.string  <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>charcter_id<span class="pl-pds">"</span></span>
    t.integer <span class="pl-s"><span class="pl-pds">"</span>power_ups_id<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

<span class="pl-k">end</span></pre></div>

<p>After creating two games named "Super Mario Bros" and "Super Mario Bros 3" you can do this:</p>

<div class="highlight highlight-source-ruby"><pre>mario.games <span class="pl-k">&lt;&lt;</span> super_mario_bros
luigi.games <span class="pl-k">&lt;&lt;</span> super_mario_bros

super_mario_bros.characters.first.name
=&gt; <span class="pl-s"><span class="pl-pds">"</span>Mario<span class="pl-pds">"</span></span>
super_mario_bros.characters.last.name
=&gt; <span class="pl-s"><span class="pl-pds">"</span>Luigi<span class="pl-pds">"</span></span>

super_mario_bros_3.characters <span class="pl-k">&lt;&lt;</span> mario
mario.games.first.name
=&gt; <span class="pl-s"><span class="pl-pds">"</span>Super Mario Bros<span class="pl-pds">"</span></span>
mario.games.last.name
=&gt; <span class="pl-s"><span class="pl-pds">"</span>Super Mario Bros 3<span class="pl-pds">"</span></span></pre></div>

<p>Closing Notes:
While writing this, I am using Sinatra and tux to interact with both Active Record and the database. One very confusing issue that came up for me with this last section was a seeming failure of the 'many to many' relationship to actually operate both ways. </p>

<p>For example, When running the final command <code>mario.games.last.name</code>, I would get <code>"Super Mario Bros"</code> instead of <code>"Super Mario Bros 3"</code>. I noticed that tux was not querying the database as it did with the <code>mario.games.first.name</code> command. Instead, it seemed to simply be pulling from the established local environment where <code>mario.games</code>, having already been queried from the database once, had only one game. Upon exiting tux, re-entering, re-establishing our 'mario' variables, and running the command <code>mario.games.last.name</code>, the database was queried and now had two games, the last of which was "Super Mario Bros 3".</p>

<h3>
<a id="final-thoughts" class="anchor" href="#final-thoughts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Final Thoughts</h3>

<p>In summing everything up from the above experiment a few simple rules emerge. Follow these, and you will arrive at Active Record Association bliss.</p>

<h5>
<a id="rules-to-live-by" class="anchor" href="#rules-to-live-by" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rules to Live By</h5>

<ul>
<li>A Parent <code>has_many</code>,  a Child <code>belongs_to</code>
</li>
<li>Give the child table the foreign key (<code>_id</code>) columns.</li>
<li>Provide the parent with information, not the child.</li>
<li>When using a <code>has_many through</code> association, the <code>through</code> table requires the foreign keys for parent and child.</li>
<li>When using a <code>has_and_belongs_to_many</code> association an additional join table is required.

<ul>
<li>This table should be named with the plural versions of both tables, joined by an underscore, and in alphabetical order.</li>
<li>It's best to remove the primary <code>id</code> key. <code>:id =&gt; false</code>
</li>
<li>Its two columns are simple foreign keys.</li>
</ul>
</li>
<li>Lastly, ask yourself what method/result you want. Refer to the above charts to help you determine which association will give you that method/result.</li>
</ul>
        </section>

        <footer>
          ActiveRecord Associations is maintained by <a href="https://github.com/dukeoflaser">dukeoflaser</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>
